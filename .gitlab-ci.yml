image: hashicorp/terraform:1.8.5

variables:
  TF_WORKDIR: "."                               # where the *.tf live
  TF_STATE_BUCKET: "wlz-tf-state-portfolio-20250512"
  TF_STATE_DDB_TABLE: "tf-locks"
  AWS_DEFAULT_REGION: "eu-west-3"

stages: [validate, plan, apply]

before_script:
  # write back-end config on the fly & init
  - |
    cat > $TF_WORKDIR/backend.tf <<EOF
    terraform {
      backend "s3" {
        bucket         = "${TF_STATE_BUCKET}"
        key            = "global/terraform.tfstate"
        region         = "${AWS_DEFAULT_REGION}"
        dynamodb_table = "${TF_STATE_DDB_TABLE}"
        encrypt        = true
      }
    }
    EOF
  - cd $TF_WORKDIR
  - terraform init -input=false -upgrade

validate:
  stage: validate
  script:
    - terraform fmt -check -recursive
    - terraform validate
  only:
    - merge_requests
    - main

plan:
  stage: plan
  script:
    - terraform plan -input=false -out=tfplan
  artifacts:
    paths: [ $TF_WORKDIR/tfplan ]
    expire_in: 1 hour
  only:
    - main

apply:
  stage: apply
  script:
    - terraform apply -input=false -auto-approve tfplan
  needs:
    - job: plan
      artifacts: true
  when: manual              # click “Play” to deploy
  only:
    - main
  environment:
    name: dev
